---
title: Design for Testability
date: 2017-01-02 19:02:25
tags:
---

设计一个新系统的时候，经常面对的一个问题就是怎么从众多的方案中选择最合适的去构造它。它们应该如何交互？

这篇文章中，我提供了一些有用的指导去回答这些问题，希望能给你一些设计上的启发。

> ##### 提高你代码的可测试性

明显的，这意味着在你写代码，当你设计它和它与其余系统的关系时，问你自己这个问题：“在与环境或其余系统不相关假设最小化的前提下，我如何测试它，我如何进行自动化测试来检验它正确。如果你不能很好的回答这个问题，那就重新设计你的抽象和接口直到你能。

我发现这种启发具有两种不同方式，我们都在接下来讨论。

### 你有很好的测试

这个也许很明显，如果你的目标是有良好测试，那么你最终很可能就会达到这个目标。

无论如何，我认为这值得深入讨论。

首先，我想强调在一个有良好测试的项目里工作是多美妙。测试修改的过程十分轻松，仅仅运行测试就可以了。不需要配置复杂的开发环境，并把修改添加到系统中。仅仅只需要运行测试，如果没有这样的保证，你没有强大的信心，保证你的代码按照你预期的那样工作，并且没有干扰其他重要的功能。

在大型成熟项目中，最难的就是修改而不影响自身，就是在不影响其他重要行为的前提下做出修改。良好的、快速的测试能为大型产品升级提供最基本的保证。

其次，为了真正的体会良好测试的好处，你需要能够运行这些测试，至少是覆盖你修改的那一部分。这是快速的，能够保证短暂的开发周期。

为了在系统扩张是保留这个特性，你需要良好的单元测试。关于界定单元、功能、集成测试以及一些其他测试，有很多派别。这里的单元测试我指的是检验某个特定的模块或者组件，他们在程序中拥有最小化依赖或极少调用其他代码。

同时你也需要一些集成测试，端到端的执行程序，来检测出组件之间不可避免又细微的相互作用。但是还是主要依赖于单元测试带来的巨大好处：

- 单元测试很快：只执行有限数量的代码，它比加载整个应用的测试更加快速。
- 更重要的是测试规模：尽可能使用单元测试的代码，测试的速度与程序大小呈线性变化。如果有更多的功能性测试，由于测试中每个组件都会依赖于其他组件，变化会接近两倍。
- 因为单元测试清晰的关联一段代码，更容易测试相关的修改，为开发提供更快的反馈。

无论如何，良好的单元测试不是偶然。没有清晰的”单元“很难写好单元测试：功能单一和良好接口定义的局部代码才能被这些接口测试。

维护成熟项目时，能拥有像这样的逻辑单元，保证良好的测试，保证快速的反馈周期的最好方式就是直接这样做：带着这样的目的写代码。

### 你将得到更好的代码

时刻想着测试去写代码的次要原因就是它确实可以使代码变得更好。让我们来思考一下可以轻松写出测试的代码具有哪些特性：

#### 对不可变数据的纯函数的偏好

不可变数据的纯函数是非常容易测试的：你仅仅需要创建一个示例输入和期望输出的对应列表。如果输入是简单可描述的，他们通常也是容易集成到类似QuickCheck这样的工具中。

#### 良好接口定义的小型模块

如果一段代码基于小的，良好定义的接口，你可以写出针对接口的黑盒测试，仅仅考虑接口规范而不用过分考虑其他内部模块或者其余系统。

#### 对IO和计算的隔离

IO通常来说更难以测试。因此可测试的系统通常将其与纯逻辑代码隔离，允许他们可以单独的测试。

#### 明确的依赖声明

使用全局定义的数据库引用比通过参数传入的代码要更难以测试的多。对于后者，你可以在测试过程中使用不同的句柄，去每次都测试一个干净的数据库，去在多线程环境下测试，或者任何你需要的场景。

通常，可测试的代码在某个特定的点通过明确的参数来传递依赖而不是假设他们是可用的。

--------

我发现上述的特性，同样也是拥有优秀架构代码的特性。带着测试的想法去构建系统，通常都会比我们意料中更好。

此外，通过测试间接的实现这些特性，使它们更加具体。这使得讨论对于一个软件系统来说怎样才是好的模块、接口、架构变得更加容易且没有限制。但是面对什么能够轻松的充分测试代码的问题时，我们更容易评估我们所作出的选择，并知道我们什么时候已经做的足够好了。

## 结论

对于复杂的软件系统来说，有一些事情比能够自信的修改代码更加重要，高质量的自动化测试就是我们带到这个目的的重要工具之一。好的测试不是偶然或者更暴力的方式，它们是由于良好的设计，并且是带着这个目的去实现它的。

当你编写软件是，总是问自己”我如何才能测试软件的正确性“，并倾向于设计来达到这个目标。作为回报，你会拥                有更强大的信心和更良好的架构，并持续下去。